- pipeline: "Boilerplate: Staging"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "develop"
  ref_type: "BRANCH"
  target_site_url: "https://boilerplate.towa-online.at/"
  actions:
  - action: "Execute: Run Composer"
    type: "BUILD"
    working_directory: "/buddy/towa-workflow-boilerplate"
    docker_image_name: "library/php"
    docker_image_tag: "7.3.0"
    execute_commands:
    - "mv .env.staging .env"
    - "composer install --no-dev"
    setup_commands:
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    mount_filesystem_path: "/buddy/towa-workflow-boilerplate"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Execute: Run Yarn in Theme"
    type: "BUILD"
    working_directory: "/buddy/towa-workflow-boilerplate"
    docker_image_name: "library/node"
    docker_image_tag: "11.0.0"
    execute_commands:
    - "cd web/app/themes/towa-theme/"
    - "yarn config set ignore-engines true"
    - "yarn"
    - "yarn prod"
    mount_filesystem_path: "/buddy/towa-workflow-boilerplate"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Upload to Staging"
    type: "RSYNC"
    input_type: "BUILD_ARTIFACTS"
    local_path: "/"
    remote_path: "/var/www/vhosts/towa-online.at/boilerplate.towa-online.at/"
    login: "$DEV_SERVER_ISENGARD_SSH_USER"
    password: "$DEV_SERVER_ISENGARD_SSH_PASS"
    host: "$DEV_SERVER_ISENGARD_HOST"
    port: "$DEV_SERVER_ISENGARD_SSH_PORT"
    authentication_mode: "PASS"
    archive: true
    compress: true
    deployment_excludes:
    - "/.*"
    - "node_modules/"
    - "auth.json"
    - "composer.json"
    - "composer.lock"
    - "buddy.yml"
    deployment_includes:
    - "/.env"
    trigger_condition: "ALWAYS"
- pipeline: "Boilerplate: Production"
  trigger_mode: "MANUAL"
  ref_name: "refs/tags/*"
  ref_type: "WILDCARD"
  target_site_url: "https://boilerplate.towa-online.at/"
  actions:
  - action: "Execute: Run Composer"
    type: "BUILD"
    working_directory: "/buddy/towa-workflow-boilerplate"
    docker_image_name: "library/php"
    docker_image_tag: "7.3.0"
    execute_commands:
    - "mv .env.production .env"
    - "composer install --no-ansi --no-dev --no-interaction --no-suggest --no-progress --no-scripts --optimize-autoloader"
    setup_commands:
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    mount_filesystem_path: "/buddy/towa-workflow-boilerplate"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Execute: Run Yarn in Theme"
    type: "BUILD"
    working_directory: "/buddy/towa-workflow-boilerplate"
    docker_image_name: "library/node"
    docker_image_tag: "11.0.0"
    execute_commands:
    - "cd web/app/themes/towa-theme/"
    - "yarn config set ignore-engines true"
    - "yarn"
    - "yarn prod"
    mount_filesystem_path: "/buddy/towa-workflow-boilerplate"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Upload to Staging"
    type: "RSYNC"
    input_type: "BUILD_ARTIFACTS"
    local_path: "/"
    remote_path: "/var/www/vhosts/towa-online.at/boilerplate.towa-online.at/"
    login: "$DEV_SERVER_ISENGARD_SSH_USER"
    password: "$DEV_SERVER_ISENGARD_SSH_PASS"
    host: "$DEV_SERVER_ISENGARD_HOST"
    port: "$DEV_SERVER_ISENGARD_SSH_PORT"
    authentication_mode: "PASS"
    archive: true
    compress: true
    deployment_excludes:
    - "/.*"
    - "node_modules/"
    - "auth.json"
    - "composer.json"
    - "composer.lock"
    - "buddy.yml"
    deployment_includes:
    - "/.env"
    trigger_condition: "ALWAYS"
